<html>
<head>
    <title>== Category Breakdown ==</title>
    <script type="text/javascript" src="/plugins/jquery-easyui-1.11.4/jquery.min.js"></script>
    <script type="text/javascript" src="/plugins/jquery-easyui-1.11.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/scripts/app-plugin.js"></script>
    <script type="text/javascript" src="/scripts/date.js"></script>
    <script type="text/javascript" src="/plugins/echarts-6.0.0/echarts.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/plugins/jquery-easyui-1.11.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/plugins/jquery-easyui-1.11.4/themes/icon.css">
    <script type="text/javascript" src="/scripts/credit.js"></script>
    <script type="text/javascript" src="/datasource/creidt-datasource.js"></script>
    
    <link rel="stylesheet" type="text/css" href="/css/default/credit/CreditBill.css">
    <script type="text/javascript"></script>
</head>
<body class="easyui-layout">
<div data-options="region:'north'" style="height: 52px">
    <div style="margin-top: 3px;">
			<span class="item_intervel">
	           	<label>Transaction date:</label> 
	           	<input id="dateStart" class="easyui-datebox" style="width: 100px;" data-options="onSelect:statistic"/>
	           	~ 
	           	<input id="dateEnd" class="easyui-datebox" style="width: 100px;" data-options="onSelect:statistic"/>
			</span>

        <span class="item_intervel">
				<label>Card type：</label>
				<input id="cmbCardTypes" class="easyui-combobox"
                       data-options="data:credit_datasource.cardTypes,valueField:'id',textField:'text',onSelect:statistic"
                       style="width: 130px;">
			</span>

        <span class="item_intervel">
	          	<label>Consume type：</label> 
            <select id="cmbConsume" class="easyui-combotree"
                        data-options="url:'/api/v1/consume/tree',method:'get',onChange:statistic" multiple
                        style="width:200px;"></select>
	          </span>

        <span class="item_intervel">
	          	<input id="txtDemo" class="easyui-textbox" style="width:120px"> 
	          </span>

        <span class="item_intervel">
	              <a class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="statistic()">Statistic</a>  
	          </span>
    </div>
</div>
<div id="chartArea" data-options="region:'center',border:false">
    <div id="main" style="width:100%; height: 320px;"></div>
</div>

<div id="dialog" style='display: none;'>
    <table id="datagrid" fit="true"
           data-options="rownumbers:true,singleSelect:true,pagination:true,pageSize:50,border:false">
        <thead>
        <tr>
            <th data-options="field:'id',hidden:true">ID</th>
            <th data-options="field:'bankCardName',width:160">Card</th>
            <th data-options="field:'transactionDate',width:80,align:'center',formatter:app.date.format">Book date</th>
            <th data-options="field:'balanceMoney',width:100,formatter:app.money.rmb">Balance money</th>
            <th data-options="field:'demoArea',width:420,align:'left'">Description</th>
        </tr>
        </thead>
    </table>
</div>
</body>
<script type="text/javascript">
$(function(){
    $.parser.onComplete = function(){
        $('#main').height($('#chartArea').height()-10);
        statistic();
        getCredits('monday');
    };
});

function getParams(){
    function safeDateboxValue(sel){ var jq=$(sel); try{ var v=jq.datebox('getValue'); if(v!=null) return $.trim(v);}catch(e){} var v2=jq.val(); return v2?$.trim(v2):''; }
    function safeComboboxValue(sel){ var jq=$(sel); try{ var v=jq.combobox('getValue'); if(v!=null) return $.trim(v);}catch(e){} var v2=jq.val(); return v2?$.trim(v2):''; }
    function safeCombotreeValues(sel){ var jq=$(sel); try{ var arr=jq.combotree('getValues'); if(arr&&arr.length) return $.trim(arr.join(',')); }catch(e){} var v2=jq.val(); return v2?$.trim(v2):''; }
    var dateStart = safeDateboxValue('#dateStart');
    var dateEnd = safeDateboxValue('#dateEnd');
    var cardtype = safeComboboxValue('#cmbCardTypes');
    if(cardtype==='0') cardtype='';
    var consume = safeCombotreeValues('#cmbConsume');
    var demoArea = (function(){ var jq=$('#txtDemo'); try{ return $.trim(jq.textbox('getValue')); }catch(e){ return $.trim(jq.val()||''); } })();
    var params = {'transactionDateStartStr':dateStart,'transactionDateEndStr':dateEnd,'consumptionType':'1','consumeID':consume,'cardTypeName':cardtype,'demoArea':demoArea};
    return params;
}

function statistic() {
	var params = getParams();
	credit.consumeReport(params, show, ajaxError);
}

</script>

<script type="text/javascript">
function show(data){
	if(data && (data.returnCode == 'success' || data.returnCode == 20000)){
		var json = null;
		try{
			json = $.parseJSON(data.returnMessage);
		}catch(e){
			json = null;
			app.messager.show({title:'Fail', msg: 'Parse return data fail!'});
			return;
		}
		if(json != null){
			var rows = json;
			var list = [];
			for (var i = 0; i < rows.length; i++) {
				var r = rows[i];
				var v = parseFloat(r.value);
				list.push({name: r.key, value: isNaN(v)?0:v});
			}
			list.sort(function(a,b){ return b.value - a.value; });
			var topN = 12;
			var agg = [];
			var others = 0;
			for(var i=0;i<list.length;i++){
				if(i<topN){ agg.push(list[i]); } else { others += list[i].value; }
			}
			if(list.length>topN && others>0){ agg.push({name:'Others', value: others}); }
			var names = []; for(var i=0;i<agg.length;i++){ names.push(agg[i].name); }
			var subtitle = list.length>topN ? 'Money · Top12+Others · Legend scroll' : 'Money';
			render(names, agg, subtitle);
		} else {
			app.messager.show({title : 'Fail', msg : data.returnMessage});
		}
	} else {
		var msg = data && data.returnMessage ? data.returnMessage : 'Request failed';
		app.messager.show({title:'Fail', msg: msg});
	}
}

function ajaxError(xhr){
    var msg = (xhr && xhr.responseText) ? xhr.responseText : 'Network error';
    app.messager.show({title:'Fail', msg: msg});
}

function render(weekNames,rowDatas,subtitle){
        ensureMainSize();
        var myChart = echarts.init(document.getElementById('main'));

        var option = {
            title : {
                text: 'Consume Pie Statistic',
                subtext: subtitle || 'Money',
                x:'center'
            },
		    tooltip : {
		        trigger: 'item',
		        formatter: "{a} <br/>{b} : {c} ({d}%)"
		    },
		    legend: {
		        type: 'scroll',
		        orient: 'vertical',
		        left: 'left',
		        top: 'middle',
		        data: weekNames
		    },
		    toolbox: {
		        show : true,
		        feature : {
		            mark : {show: true},
		            dataView : {show: true, readOnly: false},
		            magicType : {
		                show: true, 
		                type: ['pie', 'funnel'],
		                option: {
		                    funnel: {
		                        x: '25%',
		                        width: '50%',
		                        funnelAlign: 'left',
		                        max: 1548
		                    }
		                }
		            },
		            restore : {show: true},
		            saveAsImage : {show: true}
		        }
            },
		    series : [
		        {
		            name:'Category',
		            type:'pie',
		            selectedMode: 'single',
		            minAngle: 3,
		            avoidLabelOverlap: true,
		            radius : ['45%', '72%'],
		            center: ['55%', '55%'],
		            label: { formatter: '{b}: {d}%' },
		            labelLine: { length: 12, length2: 8 },
		            data:rowDatas
		        }
		    ]
		};
		
        myChart.setOption(option);
        myChart.on('click', function (param) {
            openDialog(param.name);
        });
}

function ensureMainSize(){
    var $area = $('#chartArea');
    var $main = $('#main');
    var h = $area.height();
    if(!h || h <= 40){ h = $(window).height() - 160; }
    if(h && h > 100){ $main.height(h - 20); }
}

</script>

<script type="text/javascript">
var dialog = "#dialog";
var datagrid = "#datagrid";
var dialogFlag = false;

function openDialog(consumeName){
	$(dialog).css('display','');
	var title = 'Detail - ' + consumeName;
	if(!dialogFlag){
		$(dialog).dialog({    
		    title: title,    
		    width: 800,    
		    height: 480,    
		    closed: false,    
		    cache: false,    
		    modal: true   
		});
		getCredits(consumeName);
		dialogFlag = true;
	}else{
		refreshCredits(consumeName);
		$(dialog).dialog({title:title});
		$(dialog).dialog('refresh');  
	}
}

function getCredits(consumeName){
	var week = {'consumeName': consumeName}
	var params = getParams();
	var newParams = $.extend(week,params);
	$(datagrid).datagrid({
		method: 'post',
		queryParams : newParams,
		url: '/credit/getCredits'
	});
}

function refreshCredits(consumeName){
	var week = {'consumeName': consumeName}
	var params = getParams();
	var newParams = $.extend(week,params);
	$(datagrid).datagrid('load',newParams);
}

</script>
</html>
