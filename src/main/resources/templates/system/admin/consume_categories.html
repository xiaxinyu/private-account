<html>
<head>
    <title>== Category Types ==</title>
    <script type="text/javascript" src="/plugins/jquery-easyui-1.11.4/jquery.min.js"></script>
    <script type="text/javascript" src="/plugins/jquery-easyui-1.11.4/jquery.easyui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/plugins/jquery-easyui-1.11.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/plugins/jquery-easyui-1.11.4/themes/icon.css">
    <style>
        .readonly-field .textbox-text{
            background-color: rgba(128,128,128,0.15) !important;
            color: #666 !important;
        }
        .textbox-readonly .textbox-text{
            background-color: rgba(128,128,128,0.15) !important;
            color: #666 !important;
        }
    </style>
</head>
<body class="easyui-layout">
<div data-options="region:'north'" style="height: 40px;padding:6px 8px;">
    <a class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="addRoot()">Add Root</a>
    <a class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="addChild()">Add Child</a>
    <a class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="saveCategory()">Save</a>
    <a class="easyui-linkbutton" data-options="iconCls:'icon-remove'" onclick="deleteCategory()">Delete</a>
    <a class="easyui-linkbutton" data-options="iconCls:'icon-redo'" onclick="migrateCategory()">Migrate</a>
    <a class="easyui-linkbutton" data-options="iconCls:'icon-reload'" onclick="reloadTree()">Reload Tree</a>
    <span id="hint" style="margin-left:12px;color:#888;">Select a node on the left to edit</span>
</div>

<div data-options="region:'west'" style="width: 320px; border-right: 1px solid #ddd; padding:6px;">
    <ul id="tree" class="easyui-tree" data-options="url:'/api/v1/consume/tree',method:'get'"></ul>
    <div style="margin-top:6px;color:#888;">Use right-click or toolbar to manage nodes</div>
    <div style="margin-top:6px;">
        <a class="easyui-linkbutton" data-options="iconCls:'icon-reload'" style="width:100%;" onclick="reloadTree()">Reload</a>
    </div>
    <input type="hidden" id="hidParentId" />
</div>

<div data-options="region:'center'" style="padding:12px;">
    <div style="max-width:560px;">
        <div style="margin-bottom:10px;display:none;">
            <label style="display:inline-block;width:120px;">ID</label>
            <input id="txtId" class="easyui-textbox" style="width:380px;" readonly>
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Parent Code</label>
            <input id="txtParent" class="easyui-textbox readonly-field" style="width:380px;" data-options="readonly:true">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Parent Name</label>
            <input id="txtParentName" class="easyui-textbox readonly-field" style="width:380px;" data-options="readonly:true">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Code</label>
            <input id="txtCode" class="easyui-textbox" style="width:380px;">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Name</label>
            <input id="txtName" class="easyui-textbox" style="width:380px;">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Sort</label>
            <input id="numSort" class="easyui-numberbox" style="width:120px;" data-options="min:0,precision:0">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Cascade to credits</label>
            <input id="chkCascade" type="checkbox">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Migrate To</label>
            <select id="cmbTarget" class="easyui-combotree" style="width:300px;" data-options="url:'/api/v1/consume/tree',method:'get'"></select>
            <a class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="pickCurrentTarget()">Pick current</a>
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:inline-block;width:120px;">Delete after migrate</label>
            <input id="chkDeleteAfter" type="checkbox">
        </div>
    </div>
</div>

<script type="text/javascript">
var tree = '#tree';
var currentNode = null;
var currentCat = null;
var categoriesCache = [];

$(function(){
    $(tree).tree({
        url:'/api/v1/consume/tree',
        method:'get',
        onLoadSuccess:function(){ $(tree).tree('collapseAll'); },
        onSelect:function(node){ loadNode(node); }
    });
        $('#cmbTarget').combotree({
            url:'/api/v1/consume/tree',
            method:'get',
            loadFilter:function(data){
                function mapNode(n){
                    if(!n) return n;
                    var code = n.id || '';
                    var name = n.text || '';
                    n.text = (code ? code : '') + (name ? ('  ' + name) : '');
                if(n.children && n.children.length){ for(var i=0;i<n.children.length;i++){ n.children[i] = mapNode(n.children[i]); } }
                return n;
                }
                if($.isArray(data)){ for(var i=0;i<data.length;i++){ data[i] = mapNode(data[i]); } } else { data = mapNode(data); }
                return data;
            },
            onShowPanel:function(){ try{$('#cmbTarget').combotree('tree').tree('collapseAll');}catch(e){} }
        });
    applyReadonlyStyle();
});

function fetchCategoryById(id, cb){
    if(categoriesCache && categoriesCache.length){
        var found = null;
        for(var i=0;i<categoriesCache.length;i++){ if(categoriesCache[i].id===id){ found = categoriesCache[i]; break; } }
        cb(found);
        return;
    }
    $.ajax({url:'/api/v1/consume/categories',type:'GET',success:function(res){
        categoriesCache = (res && res.rows) ? res.rows : [];
        var found = null;
        for(var i=0;i<categoriesCache.length;i++){ if(categoriesCache[i].id===id){ found = categoriesCache[i]; break; } }
        cb(found);
    }});
}

function fetchCategoryByCode(code, cb){
    if(categoriesCache && categoriesCache.length){
        var found = null;
        for(var i=0;i<categoriesCache.length;i++){ if(categoriesCache[i].code===code){ found = categoriesCache[i]; break; } }
        cb(found);
        return;
    }
    $.ajax({url:'/api/v1/consume/categories',type:'GET',success:function(res){
        categoriesCache = (res && res.rows) ? res.rows : [];
        var found = null;
        for(var i=0;i<categoriesCache.length;i++){ if(categoriesCache[i].code===code){ found = categoriesCache[i]; break; } }
        cb(found);
    }});
}

function setForm(cat){
    $('#txtId').textbox('setValue', cat && cat.id ? cat.id : '');
    $('#hidParentId').val(cat && cat.parentId ? cat.parentId : '');
    $('#txtParent').textbox('setValue', cat && cat.parentId ? cat.parentId : '');
    var parentName = '';
    if(cat && cat.parentId){
        fetchCategoryByCode(cat.parentId, function(p){ $('#txtParentName').textbox('setValue', p && p.name ? p.name : ''); });
    } else {
        $('#txtParentName').textbox('setValue','');
    }
    $('#txtCode').textbox('setValue', cat && cat.code ? cat.code : '');
    $('#txtName').textbox('setValue', cat && cat.name ? cat.name : '');
    $('#numSort').numberbox('setValue', cat && cat.sortNo!=null ? cat.sortNo : 0);
    applyReadonlyStyle();
}

function getForm(){
    var id = $('#txtId').textbox('getValue');
    var parentId = $('#hidParentId').val();
    var code = $('#txtCode').textbox('getValue');
    var name = $('#txtName').textbox('getValue');
    var sortNo = $('#numSort').numberbox('getValue');
    var deleted = (currentCat && currentCat.deleted!=null) ? currentCat.deleted : 0;
    return {id:id, parentId:parentId, code:code, name:name, sortNo: parseInt(sortNo||'0'), deleted:deleted};
}

function loadNode(node){
    currentNode = node;
    fetchCategoryByCode(node.id, function(cat){ currentCat = cat; setForm(cat||{parentId:'',sortNo:0,deleted:0}); });
}

function addRoot(){
    currentNode = null;
    currentCat = {id:'',parentId:'',code:'',name:'',sortNo:0,deleted:0};
    setForm(currentCat);
}

function addChild(){
    if(!currentNode) return;
    var parentCode = currentCat && currentCat.code ? currentCat.code : '';
    currentCat = {id:'',parentId: parentCode, code:'', name:'', sortNo:0, deleted:0};
    setForm(currentCat);
}

function saveCategory(){
    var cat = getForm();
    var method = cat.id ? 'PUT' : 'POST';
    var cascade = $('#chkCascade').is(':checked');
    var url = '/api/v1/consume/categories' + (cat.id ? '/' + cat.id : '');
    if (cascade && method==='PUT') { url += '?cascade=true'; }
    $.ajax({url:url,type:method,contentType:'application/json',data:JSON.stringify(cat),success:function(r){
        categoriesCache = [];
        $(tree).tree('reload');
        if(r && r.id){ $('#txtId').textbox('setValue', r.id); }
        $.messager.show({title:'OK',msg:'Saved successfully'});
    },error:function(xhr){
        var msg = xhr && xhr.responseText ? xhr.responseText : 'Error';
        var isDup = (xhr && (xhr.status===409)) || (msg && (msg.indexOf('Duplicate')>=0 || msg.indexOf('重复')>=0));
        if(isDup){ $.messager.alert('Warning', 'Duplicate id/code, please change'); }
        else { $.messager.alert('Error', msg); }
    }});
}

function deleteCategory(){
    var id = $('#txtId').textbox('getValue');
    var name = $('#txtName').textbox('getValue');
    if(!id) return;
    var childrenCount = 0;
    if(currentNode && currentNode.children && currentNode.children.length){ childrenCount = currentNode.children.length; }
    var msg = childrenCount>0 ? ('确认删除“'+(name||id)+'”及其'+childrenCount+'个子节点？') : ('确认删除“'+(name||id)+'”？');
    $.messager.confirm('Confirm Delete', msg, function(r){
        if(!r) return;
        $.ajax({url:'/api/v1/consume/categories/'+id,type:'DELETE',success:function(){
            setForm({parentId:'',sortNo:0,deleted:0});
            categoriesCache = [];
            $(tree).tree('reload');
            $.messager.show({title:'OK',msg:'Deleted successfully'});
        },error:function(xhr){ $.messager.alert('Error', xhr.responseText || 'Error'); }});
    });
}

function reloadTree(){ $(tree).tree('reload'); }

function applyReadonlyStyle(){
    try{
        $('#txtParent').textbox('readonly', true);
        $('#txtParentName').textbox('readonly', true);
        $('#txtParent').textbox('textbox').css({'background-color':'rgba(128,128,128,0.15)','color':'#666'});
        $('#txtParentName').textbox('textbox').css({'background-color':'rgba(128,128,128,0.15)','color':'#666'});
    }catch(e){}
}

function migrateCategory(){
    var id = $('#txtId').textbox('getValue');
    var name = $('#txtName').textbox('getValue');
    if(!id) return;
    var tgt = '';
    try{ tgt = $('#cmbTarget').combotree('getValue'); }catch(e){ tgt = ''; }
    if(!tgt){ $.messager.alert('Tip','Please select a target category'); return; }
    var srcCode = $('#txtCode').textbox('getValue');
    if(srcCode && tgt && $.trim(srcCode) === $.trim(tgt)){
        $.messager.alert('Warning','Source and target are the same; nothing to migrate');
        return;
    }
    var cascade = $('#chkCascade').is(':checked');
    var deleteAfter = $('#chkDeleteAfter').is(':checked');
    var url = '/api/v1/consume/categories/'+id+'/migrate?toCode='+encodeURIComponent(tgt)+'&deleteAfter='+(deleteAfter?'true':'false')+'&cascade='+(cascade?'true':'false');
    $.messager.confirm('Confirm Migration','Move credits of "'+(name||id)+'" to "'+tgt+'"'+(deleteAfter?' and delete the source category':'')+'?', function(r){
        if(!r) return;
        $.ajax({url:url,type:'POST',success:function(){
            categoriesCache = [];
            $(tree).tree('reload');
            setForm({parentId:'',sortNo:0,deleted:0});
            $.messager.show({title:'OK',msg:'Migration completed'});
        },error:function(xhr){ $.messager.alert('Error', xhr.responseText || 'Error'); }});
    });
}

function pickCurrentTarget(){
    if(!currentNode){ $.messager.alert('Tip','Please select a category on the left'); return; }
    try{
        $('#cmbTarget').combotree('setValue', currentNode.id);
    }catch(e){}
}
</script>

<div data-options="region:'south'" style="height:0px;display:none;"></div>
</script>
</body>
</html>
