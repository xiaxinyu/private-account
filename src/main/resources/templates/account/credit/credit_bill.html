<html>
<head>
    <title>== Bill Management List ==</title>
    <script type="text/javascript" src="/plugins/jquery-easyui-1.11.4/jquery.min.js"></script>
    <script type="text/javascript" src="/plugins/jquery-easyui-1.11.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/scripts/app-plugin.js"></script>
    <script type="text/javascript" src="/scripts/date.js"></script>
    <script type="text/javascript" src="/plugins/echarts/echarts-2.2.7.js"></script>
    <link rel="stylesheet" type="text/css" href="/plugins/jquery-easyui-1.11.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="/plugins/jquery-easyui-1.11.4/themes/icon.css">
    <script type="text/javascript" src="/scripts/credit.js"></script>
    <script type="text/javascript" src="/datasource/creidt-datasource.js"></script>
    
    <link rel="stylesheet" type="text/css" href="/css/default/credit/CreditBill.css">
</head>
<body class="easyui-layout">
<div data-options="region:'north',border:false" style="height: 50px">
    <div class="toolbar" style="height: 100%;">
			<span class="item_intervel">
	           	<label>Date</label>
            <input id="dateStart" class="easyui-datebox" style="width: 120px;"
                       phptag="phptag_home_m_1_1001"/>
	           	~ 
            <input id="dateEnd" class="easyui-datebox" style="width: 120px;"/>
			</span>

        <span class="item_intervel">
	           	<label>Type</label>
                <input id="cmbConsumptionType" class="easyui-combobox"
                       data-options="data:credit_datasource.consumptionType,valueField:'id',textField:'text',editable:false,prompt:'All types'"
                       style="width: 120px;">
			</span>

        <span class="item_intervel">
				<label>Card</label>
                <input id="cmbCardTypes" class="easyui-combobox"
                       data-options="url:'/api/v1/cards/list',method:'get',valueField:'key',textField:'value',editable:false,prompt:'All cards'"
                       style="width: 160px;">
			</span>

        <span class="item_intervel">
	          	<label>Consume</label>
                <select id="cmbConsume" class="easyui-combotree"
                        data-options="url:'/api/v1/consume/tree',method:'get'" multiple
                        style="width:260px;"></select>
	          </span>

                <span class="item_intervel">
            	  	<input id="txtDemo" class="easyui-textbox" data-options="prompt:'Keyword'" style="width:160px"> 
          	  </span>

        <span class="item_intervel">
	              <a class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="searchCredits()">Search</a>
	              <a class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="">Export</a>
	          </span>
    </div>
</div>
<div data-options="region:'center',border:false">
    <table id="datagrid" fit="true"
           data-options="rownumbers:true,singleSelect:true,pagination:true,pageSize:200,pageList:[50, 100, 150, 200, 500]">
        <thead>
        <tr>
            <th data-options="field:'id',hidden:true">ID</th>
            <th data-options="field:'bankCardName',width:160">Card Name</th>
            <th data-options="field:'transactionDate',width:80,align:'center',formatter:app.date.format">Posting Date</th>
            <th data-options="field:'transactionDesc',width:250,align:'left'">Narration</th>
            <th data-options="field:'balanceCurrency',width:80,align:'center'">Currency</th>
            <th data-options="field:'balanceMoney',width:100,formatter:app.money.rmb">Amount</th>
            <th data-options="field:'consumptionType',width:110,align:'center',formatter:fmt.consumptionType,editor:{type:'combobox',options:{valueField:'id',textField:'text',data:credit_datasource.consumptionType}}">
                Transaction Type
            </th>
            <th data-options="field:'consumeCode',width:220,align:'left',formatter:function(v,r){return r.consumeName||'';},editor:{type:'combotree',options:{url:'/api/v1/consume/tree',method:'get',loadFilter:function(data){function mapNode(n){if(!n) return n;var code=n.id||'';var name=n.text||'';n.text=(code?code:'')+(name?('  '+name):'');if(n.children&&n.children.length){for(var i=0;i<n.children.length;i++){n.children[i]=mapNode(n.children[i]);}}return n;}if($.isArray(data)){for(var i=0;i<data.length;i++){data[i]=mapNode(data[i]);}}else{data=mapNode(data);}return data;},onShowPanel:function(){try{$(this).combotree('tree').tree('collapseAll');}catch(e){}},onLoadSuccess:function(){try{$(this).combotree('tree').tree('collapseAll');}catch(e){}}}}">
                Category
            </th>
            <th data-options="field:'demoArea',width:420,align:'left',editor:{type:'textbox'}">Remarks</th>
        </tr>
        </thead>
    </table>
</div>
</body>

<script type="text/javascript">
var datagrid = '#datagrid';
var editIndex = undefined;
$(function() {
    $(datagrid).datagrid({
        method:'post',
        title:'Total:<span id="totalConsume" style="color:red">0</span>',
        url: '/credit/getCredits',
        fitColumns:true,
        striped:true,
        autoRowHeight:true,
        scrollbarSize:14,
        onDblClickRow:function(rowIndex, rowData){
            $(this).datagrid('cancelEdit', editIndex);
            editIndex = rowIndex;
            $(this).datagrid('beginEdit', rowIndex);
        },
		onClickRow:function(rowIndex, rowData){
			$(this).datagrid('cancelEdit', editIndex);
		},
		onLoadSuccess:function(data){
			var rowDatas = data.rows;
			if(rowDatas != undefined && rowDatas.length > 0){
				var total = 0;
				for(var i=0;i<rowDatas.length;i++){
					total += rowDatas[i].balanceMoney;
				}
				$("#totalConsume").html(Math.round(total));
			}
		}
	});
	
	var pager = $(datagrid).datagrid('getPager'); // get the pager of datagrid
	pager.pagination({
	    pageSize: 200,
	    pageList: [50, 100, 150, 200, 500],
		buttons : [ {
			iconCls : 'icon-cancel',
			handler : deleteCredit
		}, {
			iconCls : 'icon-edit',
			handler : function() {
				alert('edit');
			}
		}, {
			iconCls : 'icon-save',
			handler : updateCredit
		} , {
			iconCls : 'icon-undo',
			handler : cancelEdit
		}]
	});
});

$(function(){
    $.parser.onComplete = function(){
        $('#dateStart').datebox({onSelect:function(){searchCredits();}});
        $('#dateEnd').datebox({onSelect:function(){searchCredits();}});
        $('#cmbConsumptionType').combobox({onSelect:function(){searchCredits();}});
        $('#cmbCardTypes').combobox({onSelect:function(){searchCredits();},onShowPanel:function(){ $('#cmbCardTypes').combobox('reload'); }});
        $('#cmbCardTypes').combobox('reload');
        $('#cmbConsume').combotree({
            url:'/api/v1/consume/tree',
            method:'get',
            loadFilter:function(data){
                function mapNode(n){
                    if(!n) return n;
                    var code = n.id || '';
                    var name = n.text || '';
                    n.text = (code ? code : '') + (name ? ('  ' + name) : '');
                    if(n.children && n.children.length){
                        for(var i=0;i<n.children.length;i++){ n.children[i] = mapNode(n.children[i]); }
                    }
                    return n;
                }
                if($.isArray(data)){
                    for(var i=0;i<data.length;i++){ data[i] = mapNode(data[i]); }
                } else { data = mapNode(data); }
                return data;
            },
            onLoadSuccess:function(){ try{$('#cmbConsume').combotree('tree').tree('collapseAll');}catch(e){} },
            onChange:function(){searchCredits();},
            onShowPanel:function(){
                try{
                    var treeObj = $('#cmbConsume').combotree('tree');
                    setTimeout(function(){ try{ treeObj.tree('collapseAll'); }catch(e){} }, 0);
                }catch(e){}
            }
        });
        try{$('#cmbConsume').combotree('reload','/api/v1/consume/tree');}catch(e){}
    };
});

function deleteCredit(){
	var rowData = $(datagrid).datagrid("getSelected");
	if(rowData != null){
		$.messager.confirm('Confirm', 'Do you want to delete this credit record？', function(r){
			if (r){
			    credit.deleteCredit({'id':rowData.id}, function(data){
			    	if(data.returnCode == 'success'){
			    		$(datagrid).datagrid('reload');
			    		app.messager.show({title:'Success', msg:'Success to delete this credit record!'});
			    	}else{
			    		app.messager.show({title:'Fail', msg: data.returnMessage});
			    	}
			    },function(e){
					app.messager.show({title:'Error', msg: e.message});
				})
			}
		});
	}else{
		app.messager.show({title:'Delete credit record', msg:'Please select one credit record!'});
	}
}
	
var fmt = {
	consumptionType:function(value,row){
	           if (value == 0) {
		        return;
		 }
		var consumptionTypes = credit_datasource.consumptionType;
		for (var i = 0; i < consumptionTypes.length; i++) {
			if (consumptionTypes[i].id == value) {
		    	return consumptionTypes[i].text;
		    }
		}
	},
    consume:function(value,row){
        var consumeTarget = consume_operate.find(value);
        if(consumeTarget){ return consumeTarget.text; }
        return "";
    }
}

var consume_operate = {};

function updateCredit() {
	var rowData = $(datagrid).datagrid('getSelected');
	var rowIndex = $(datagrid).datagrid('getRowIndex',rowData);
	
	var consumptionTypeEidtor = $(datagrid).datagrid('getEditor', {index:rowIndex,field:'consumptionType'});
	var consumptionType = $(consumptionTypeEidtor.target).combobox('getValue');
	
    var consumeEidtor = $(datagrid).datagrid('getEditor', {index:rowIndex,field:'consumeCode'});
    var consumeCode = $(consumeEidtor.target).combotree('getValue');
    var consumeText = $(consumeEidtor.target).combotree('getText');
    var consumeName = (function(){
        var t = $.trim(consumeText||'');
        var c = $.trim(consumeCode||'');
        if(!t) return '';
        if(c && t.indexOf(c) === 0){
            var s = t.substring(c.length);
            return $.trim(s);
        }
        return t;
    })();
	
	var demoAreaEidtor = $(datagrid).datagrid('getEditor', {index:rowIndex,field:'demoArea'});
	var demoArea = $(demoAreaEidtor.target).textbox('getText');
	
    var params = {'id':rowData.id, 'consumptionType':consumptionType,'demoArea':$.trim(demoArea),'consumeCode':consumeCode,'consumeName':consumeName};
	credit.updateCredit(params, function(data){
    	if(data.returnCode == 'success'){
    		$(datagrid).datagrid('reload');
    	}else{
    		app.messager.show({title:'Fail', msg: data.returnMessage});
    	}
    });
}

function cancelEdit() {
	var rows = $(datagrid).datagrid('getRows');
	for (var i = 0; i < rows.length; i++) {
		$(datagrid).datagrid('cancelEdit', i);
	}
}

</script>

<script type="text/javascript">
function searchCredits() {
    var dg = $(datagrid);
    if (!dg.length) {
        return;
    }
    var st = dg.data('datagrid');
    if (!st || !st.options) {
        return;
    }
    function safeDateboxValue(sel){
        var jq = $(sel);
        try { var v = jq.datebox('getValue'); if(v!=null) return $.trim(v); } catch(e) {}
        var v2 = jq.val(); return v2 ? $.trim(v2) : '';
    }
    function safeComboboxValue(sel){
        var jq = $(sel);
        try { var v = jq.combobox('getValue'); if(v!=null) return $.trim(v); } catch(e) {}
        var v2 = jq.val(); return v2 ? $.trim(v2) : '';
    }
    function safeCombotreeValues(sel){
        var jq = $(sel);
        try { var arr = jq.combotree('getValues'); if(arr&&arr.length) return $.trim(arr.join(',')); } catch(e) {}
        var v2 = jq.val(); return v2 ? $.trim(v2) : '';
    }

    var dateStart = safeDateboxValue('#dateStart');
    var dateEnd = safeDateboxValue('#dateEnd');

    var consumptionType = safeComboboxValue('#cmbConsumptionType');
    if(consumptionType === '0') consumptionType = '';

    var cardId = safeComboboxValue('#cmbCardTypes');
    if(cardId === '0' || cardId === 'kong') cardId = '';

    var consume = safeCombotreeValues('#cmbConsume');
    var demoArea = (function(){
        var jq = $('#txtDemo');
        try { return $.trim(jq.textbox('getValue')); } catch(e) { return $.trim(jq.val()||''); }
    })();

    dg.datagrid('load',{
        'transactionDateStartStr':dateStart,
        'transactionDateEndStr':dateEnd,
        'consumptionType':consumptionType,
        'consumeID':consume,
        'cardId':cardId,
        'demoArea':demoArea,
        'weekName':''
    });
}

</script>

</html>
